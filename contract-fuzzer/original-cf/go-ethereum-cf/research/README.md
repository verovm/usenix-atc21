# Research Stage1: Substate - Record/Replay Transactions Efficiently

For our research, we need to execute all transactions from mainnet blockchain.
Previously we imported and synced block segments to execute all trasnactions.
Disadvantages of this method is:
1. It takes too much time to finish the entire blockchain
(several months for 0-10M).
The main reason is key encryption and trie traversal overhead
to access Ethereum states [Kamil's Ethereum storage paper].
2. It takes too much space to maintain entire Ethereum states,
while most of Ethereum transactions access only a few of them.
This limits the number of segments we can process simultaneously.
3. It is affected by malicious transactions, e.g., DoS attacks,
getting extremely slower with no meaningful state transitions.
4. It may require to run the entire blocks in the segment again
although we want to run several of them. Otherwise, we should
create additional DB snapshot and block segment.

We define _subsate_ of a transaction is a subset of Ethereum states
required for transaction execution.
Our goal is to record substates of transactions that is minimal while
it is sufficient to generate the same output in replaying transactions.
Since key encryption and trie traversal is huge overhead
in replaying transactions, we flatten world state trie
and account storage tries into more efficient data structure
(`map` in Go language, `{}` in JSON).

## Record transaction substates
Use `geth import` to save transaction substates in `./stage1-substate/`.

There are 5 data structure stored in substate DB:
1. `SubstateAccount`: account information (nonce, balance, code, storage)
2. `SubstateAlloc`: mapping of account address and `SubstateAccount`
3. `SubstateEnv`: information from block headers (block gasLimit, number, timestamp, hashes)
4. `SubstateMessage`: message for transaction execution
5. `SubstateResult`: result of transaction execution

There are 5 values which are required to replay transactions and validate results:
1. `InputAlloc`: alloc that read during transaction execution
2. `Env`: block information required for trasnaction execution
3. `Message`: array with exactly 1 trasnaction
4. `OutputAlloc`: alloc that generated by transaction execution
5. `Result`: execution result and receipt array with exactly 1 receipt

`./stage1-substate/substate` contains mapping of key `N_T` to substate with transaction index `T` at block `N`.
`./stage1-substate/code` contains mapping of codeHash to bytecode.

## Replay trasnactions

`evm transition-substate` (`evm t8n-substate`) receives range of blocks,
loads substates of transactions within the range from `./stage1-substate/`,
execute them and check whether execution results are correct.
If `evm t8n` finds an execution result is not equivalent to the recorded one,
it returns an error immediately.

For example, if you want to replay trasnactions from 46147 to 50000:
```bash
# replay transactions and check whether execution results are correct
./evm t8n-substate 46147 50000
```

Here are command line options for `evm t8n-substate`:
```
transition-substate [command options] [arguments...]

The transition-substate (t8n-substate) command requires
two arguments: <blockNumFirst> <blockNumLast>
<blockNumFirst> and <blockNumLast> are the first and
last block of the inclusive range of blocks to dump substates.

OPTIONS:
   --workers value                    Number of workers that execute transactions in parallel (default: 4)
   --skip-transfer-txs                Skip executing transactions that only transfer ETH
   --skip-call-txs                    Skip executing CALL transactions to accounts with contract bytecode
   --skip-create-txs                  Skip executing CREATE transactions
```

For example, if you want 8 workers to replay transactions except CREATE transactions:
```bash
# 8 workers will replay transactions that invoke bytecode execution
./evm t8n-substate 46147 50000 --workers 8 --skip-create-txs
```

If you want to replay only CREATE transactions:
```bash
# 8 workers will replay transactions that invoke bytecode execution
./evm t8n-substate 46147 50000 --skip-transfer-txs --skip-call-txs
```

The speed of `evm t8n` with 1GB substate DB generated with 100k-block segments
(0-0.1M, ..., 3-3.1M) was 3000 tx/s.
